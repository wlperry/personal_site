---
title: "How to work with lake profile data"
output:
  html_document: default
---

This code loads the libraries: # echo=FALSE hides the output
```{r, echo=FALSE} 
library(tidyverse)
library(ggplot2)
library(dplyr)
library(tidyr)
library(reshape2)
library(scales)
library(lubridate)
library(readxl)
library(readr)
library(knitr)
library(gridExtra)
# library(cowplot)
library(grid)

# for na approx
library(zoo)


```

## Import the lake profile data from chla/Prodcution and smoothed temperature data
```{r, echo=FALSE}
# ltm data
ltm_prod_profile <- read_csv("2016 10 27 ltm chlorophyll and primary prod.csv")
ltm_prod_profile <- ltm_prod_profile %>% mutate(site="ltm")
ltm_prod_profile$date <- mdy(ltm_prod_profile$date)
ltm_prod_profile$chl <- na.approx(ltm_prod_profile$chl, rule=2)
ltm_prod_profile$pprod <- na.approx(ltm_prod_profile$pprod, rule=2)

# ltm data
ltm_temp_profile <- read_csv("2016 10 27 ltm temp profiles.csv")
ltm_temp_profile <- ltm_temp_profile %>% mutate(site="ltm")
ltm_temp_profile$date <- mdy(ltm_temp_profile$date)
ltm_temp_profile$temp <- na.approx(ltm_temp_profile$temp, rule=2)

ltm_p_profile <- read_csv("2016 10 27 ltm phosphorus.csv")
ltm_p_profile <- ltm_p_profile %>% mutate(site="ltm")
ltm_p_profile$date <- mdy(ltm_p_profile$date)

```

How to do na.approximations
http://stackoverflow.com/questions/23339209/substitute-na-values-depending-of-position-in-dataframe
lets leave this alone or now and get to the rest of this
```{r}
#ltm_fullprofile$pH_smooth_filled <- na.approx(ltm_fullprofile$pH_smooth, rule=2)
# get rid of the 8-05 temp data


```

Merge data from both dataframes keeping all data
from: http://stackoverflow.com/questions/1299871/how-to-join-merge-data-frames-inner-outer-left-right
```{r}
ltm_fullprofile <- merge(ltm_prod_profile, ltm_temp_profile, by = c("site","date","depth"), all = TRUE)
# filter data to less than 100 m
ltm_fullprofile <- ltm_fullprofile %>% filter(depth<=100)
ltm_fullprofile <- ltm_fullprofile %>% filter(depth>=1)
```


Assign Season - this is not needed as they have all of them now
```{r}
ltm_fullprofile$month <- as.numeric(format(ltm_fullprofile$date,"%m"))
ltm_fullprofile <- mutate(ltm_fullprofile, season = ifelse(month > "4" | month < "10", "dry", "wet"))
```

Mean and SE of all values in a new dataframe
http://stackoverflow.com/questions/29821841/dplyr-summarise-each-standard-error-function
```{r}
ltm_fullprofile_means <- ltm_fullprofile %>% 
  group_by(season, depth) %>%
  summarise(
    chl_mean =mean(chl, na.rm=TRUE), chl_sd=sd(chl, na.rm=TRUE), chl_sem = sd(chl, na.rm=TRUE)/sqrt(length(chl)),
    pprod_mean =mean(pprod, na.rm=TRUE), pprod_sd=sd(pprod, na.rm=TRUE), pprod_sem = sd(pprod, na.rm=TRUE)/sqrt(length(pprod)),
    zmix_mean =mean(zmix, na.rm=TRUE), zmix_sd=sd(zmix, na.rm=TRUE), zmix_sem = sd(zmix, na.rm=TRUE)/sqrt(length(zmix)),
    zthermocline_mean =mean(zthermocline, na.rm=TRUE), zthemrocline_sd=sd(zthermocline, na.rm=TRUE), zthemrocline_sem = sd(zthermocline, na.rm=TRUE)/sqrt(length(zthermocline)),
    zhypo_mean =mean(zhypo, na.rm=TRUE), zhypo_sd=sd(zhypo, na.rm=TRUE), zhypo_sem = sd(zhypo, na.rm=TRUE)/sqrt(length(zhypo)),
    temp_mean =mean(temp, na.rm=TRUE), temp_sd=sd(temp, na.rm=TRUE), temp_sem = sd(temp, na.rm=TRUE)/sqrt(length(temp))
  )
```


Now to make the ltm_fullprofile_means wide for plotting using RESHAPE
http://seananderson.ca/2013/10/19/reshape.html

```{r}
require(reshape2)
ltm_fullprofile_means<- ltm_fullprofile_means %>% ungroup()

# go to full long format
ltm_seasonmeans_widestep1 <- melt(ltm_fullprofile_means, id.vars = c("season", "depth"))
ltm_seasonmeans_wide <- dcast(ltm_seasonmeans_widestep1, depth ~ season + variable)
rm(ltm_seasonmeans_widestep1)
```




Here is where we have to get sums by zones
```{r}
ltm_zonesums_bydate <- ltm_fullprofile %>% 
  group_by(season,date, zone) %>%
  summarise(
    chl_sum =sum(chl, na.rm=TRUE), chl_N = length(chl),
    pprod_sum =sum(pprod, na.rm=TRUE), pprod_N=length(pprod)
    )
```


Now to get the averages by zone from the ltm_zonesums_bydate dataframe
```{r}
ltm_zonemeans_season <- ltm_zonesums_bydate %>% 
  group_by(season, zone) %>%
  summarise(
    chl_mean =mean(chl_sum, na.rm=TRUE), chl_sd=sd(chl_sum, na.rm=TRUE), chl_sem = sd(chl_sum, na.rm=TRUE)/sqrt(length(chl_sum)),
    pprod_mean =mean(pprod_sum, na.rm=TRUE), pprod_sd=sd(pprod_sum, na.rm=TRUE), pprod_sem = sd(pprod_sum, na.rm=TRUE)/sqrt(length(pprod_sum))
    )
```


Lake Tanganyika Kigoma site for primary production with depth
```{r, echo=FALSE}

ltm_pprod <- ltm_fullprofile %>%
  group_by(season, depth) %>%
  summarize(mean_pprod = mean(pprod, na.rm=TRUE), sem = sd(pprod)/sqrt(length(pprod))) %>%
  ggplot(aes(x=mean_pprod, y=depth, color=season)) + 
   geom_point()+
  geom_path()+
   geom_errorbarh(aes(xmax = mean_pprod + sem, xmin = mean_pprod - sem),
                  width=0,
                   height=0,
                  size=1.15, 
                  alpha =.2)+
  # stat_summary(fun.data="mean_cl_normal") +
  # stat_summary(fun.y="mean", geom="line")+
  # geom_segment(aes(x = 0.065, xend = .085, y = 28, yend = 28), color = "darkblue")+
  #  geom_segment(aes(x = 0.01, xend = 0.03, y = 50, yend = 50), color = "darkblue")+
  # annotate("text", x=0.17, y=28, label= "metalimnion")+
  # annotate("text", x=0.06, y=50, label= "hypolimnion")+
  scale_x_continuous( position = "top", limits=c(0,.19), expand = c(0,0))+ #
  scale_y_reverse(expand = c(0.015,0))+
  scale_color_manual(name="Season", values=c("black", "darkgrey"), labels=c("Dry Season", "Wet Season"))+
  xlab(bquote('Primary Production (G m'^-2~Day^-1*')'))+ # http://stackoverflow.com/questions/27445452/superscript-and-subscript-axis-labels-in-ggplot2
  ylab("Depth (m)")
ltm_pprod
  
# limits=c(110,0), 
   # stat_smooth(method="loess",size=1.5) 
  
```

Lake Tanganyika Kigoma site for chlorphyll a with depth 
```{r, echo=FALSE}
ltm_chl <- ltm_fullprofile %>% 
  group_by(season, depth) %>%
  summarize(mean_chl = mean(chl, na.rm=TRUE), sem = sd(chl)/sqrt(length(chl))) %>%
  ggplot(aes(x=mean_chl, y=depth, color=season)) + 
   geom_point()+
  geom_path()+
  # geom_point()+
  geom_errorbarh(aes(xmax = mean_chl + sem, xmin = mean_chl - sem),
                  width=0,
                   height=0,
                  size=1.15, 
                  alpha =.2)+
  # geom_ribbon(aes(xmin = mean_temp - sem, xmax = mean_temp + sem, y=depth, colour = "season"), alpha = 0.3)+
  # stat_summary(fun.data="mean_cl_normal") +
  # stat_summary(fun.y="mean", geom="line")+
  # geom_segment(aes(x = 0.065, xend = .085, y = 28, yend = 28), color = "darkblue")+
  #  geom_segment(aes(x = 0.01, xend = 0.03, y = 50, yend = 50), color = "darkblue")+
  # annotate("text", x=0.17, y=28, label= "metalimnion")+
  # annotate("text", x=0.06, y=50, label= "hypolimnion")+
  scale_x_continuous( position = "top", expand = c(0,0), limits=c(0,.7))+ #, limits=c(0,.19)
  scale_y_reverse(expand = c(0.015,0))+
  scale_color_manual(name="Season", values=c("black", "darkgrey"), labels=c("Dry Season", "Wet Season"))+
  xlab(bquote('chlorophyll a (mg L'^-2~')'))+ # http://stackoverflow.com/questions/27445452/superscript-and-subscript-axis-labels-in-ggplot2
  ylab("Depth (m)")
ltm_chl
```

Lake Tanganyika Mahale site for chlorphyll a sums by zone
```{r, echo=FALSE}
ltm_zonesums_bydate$zone_factor <- as.factor(ltm_zonesums_bydate$zone)
ltm_chl_sum <- ltm_zonesums_bydate %>% 
  group_by(zone_factor) %>%
  ggplot(aes(x=date, y=chl_sum, color=zone_factor)) + 
   geom_point()+
  geom_line()+
  scale_x_date(date_breaks = "3 months",  date_minor_breaks = "1 week", date_labels = "%B", expand = c(0,0)) 
#facet_wrap("season")
ltm_chl_sum
```

Lake Tanganyika Mahale site for prmary prod sums by zone
```{r, echo=FALSE}
ltm_zonesums_bydate$zone_factor <- as.factor(ltm_zonesums_bydate$zone)
ltm_pprod_sum <- ltm_zonesums_bydate %>% 
  group_by(zone_factor) %>%
  ggplot(aes(x=date, y=pprod_sum, color=zone_factor)) + 
   geom_point()+
  geom_line()+
  scale_x_date(date_breaks = "3 months",  date_minor_breaks = "1 week", date_labels = "%B", expand = c(0,0)) 
#facet_wrap("season")
ltm_pprod_sum
```


writecsv files of output
# ```{r}
# write_csv(ltm_fullprofile,"./output/ltm profile merged chl and prod and smoothed.csv")
# 
# write_csv(ltm_fullprofile_means,"./output/ltm profile means with depth.csv")
# 
# write_csv(ltm_zonesums_bydate,"./output/ltm profile sums for each date and zone.csv")
# 
# write_csv(ltm_zonemeans_season,"./output/ltm profile means of the summed chl and pprod data.csv")
# 
# write_csv(ltm_seasonmeans_wide,"./output/ltm profile wide format.csv")

# ```
